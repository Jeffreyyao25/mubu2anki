<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anki Converter Pro</title>
    <style>
        :root {
            --apple-blue: #0066cc;
            --apple-bg: #ffffff;
            --apple-grey: #f5f5f7;
            --apple-border: #d2d2d7;
            --apple-text: #1d1d1f;
            --apple-sub: #86868b;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
            background-color: var(--apple-bg);
            color: var(--apple-text);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            -webkit-font-smoothing: antialiased;
        }

        .container {
            width: 100%;
            max-width: 720px;
            padding: 80px 24px;
            opacity: 0;
            transform: translateY(20px);
            animation: fadeIn 0.8s ease forwards;
        }

        @keyframes fadeIn {
            to { opacity: 1; transform: translateY(0); }
        }

        header {
            text-align: center;
            margin-bottom: 60px;
        }

        h1 {
            font-size: 56px;
            font-weight: 600;
            letter-spacing: -0.02em;
            margin: 0 0 12px 0;
        }

        .subtitle {
            font-size: 24px;
            color: var(--apple-sub);
            font-weight: 400;
        }

        .section {
            margin-bottom: 40px;
            width: 100%;
        }

        .label {
            font-size: 12px;
            font-weight: 700;
            color: var(--apple-sub);
            margin-bottom: 12px;
            display: block;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        .file-drop-zone {
            position: relative;
            width: 100%;
            height: 140px;
            border: 1px solid var(--apple-border);
            border-radius: 18px;
            background-color: var(--apple-grey);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .file-drop-zone:hover, .file-drop-zone.dragover {
            border-color: var(--apple-blue);
            background-color: #fff;
            box-shadow: 0 8px 24px rgba(0,0,0,0.04);
            transform: scale(1.01);
        }

        .file-drop-zone .icon-text {
            color: var(--apple-blue);
            font-size: 18px;
            font-weight: 500;
        }

        #file-name-info {
            margin-top: 6px;
            font-size: 14px;
            color: var(--apple-sub);
        }

        input[type="file"] {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        textarea {
            width: 100%;
            height: 220px;
            padding: 24px;
            border: 1px solid var(--apple-border);
            border-radius: 18px;
            font-family: "SF Mono", "Menlo", monospace;
            font-size: 13px;
            line-height: 1.6;
            color: var(--apple-text);
            background: #fff;
            box-sizing: border-box;
            outline: none;
            transition: all 0.3s;
        }

        textarea:focus {
            border-color: var(--apple-blue);
            box-shadow: 0 0 0 4px rgba(0, 102, 204, 0.08);
        }

        .settings-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            background: var(--apple-grey);
            border-radius: 18px;
        }

        .radio-group {
            display: flex;
            gap: 24px;
        }

        .radio-group label {
            font-size: 15px;
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        input[type="radio"] {
            margin-right: 8px;
            width: 18px;
            height: 18px;
            accent-color: var(--apple-blue);
        }

        .btn-apple {
            background-color: var(--apple-blue);
            color: white;
            border: none;
            padding: 12px 28px;
            border-radius: 980px;
            font-size: 17px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-apple:hover { background-color: #0077ed; }
        .btn-apple:disabled { background-color: #d2d2d7; color: #f5f5f7; cursor: not-allowed; }

        footer {
            margin-top: 100px;
            padding-bottom: 40px;
            font-size: 12px;
            color: var(--apple-sub);
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>Anki Converter</h1>
        <div class="subtitle">Designed for simplicity.</div>
    </header>

    <div class="section">
        <span class="label">Step 1. 选取文件</span>
        <div class="file-drop-zone" id="drop-zone">
            <span class="icon-text">选取 OPML 文件</span>
            <span id="file-name-info">支持拖拽或点击</span>
            <input type="file" id="file_input" accept=".opml">
        </div>
    </div>

    <div class="section">
        <span class="label">Step 2. 预览内容</span>
        <textarea id="output_box" readonly placeholder="CSV 内容将在此处显示..."></textarea>
        <textarea id="input_box" style="display:none;"></textarea>
    </div>

    <div class="section">
        <div class="settings-bar">
            <div class="radio-group">
                <label><input type="radio" name="list_type" value="ordered" checked> 有序</label>
                <label><input type="radio" name="list_type" value="unordered"> 无序</label>
                <label><input type="radio" name="list_type" value="none"> 素颜</label>
            </div>
            <button id="save_btn" class="btn-apple" disabled>保存 CSV</button>
        </div>
    </div>

    <footer>Designed for Mubu users. Keep Learning.</footer>
</div>

<script>
(function() {
    const inputBox = document.getElementById('input_box');
    const outputBox = document.getElementById('output_box');
    const fileInput = document.getElementById('file_input');
    const saveBtn = document.getElementById('save_btn');
    const fileNameInfo = document.getElementById('file-name-info');
    const dropZone = document.getElementById('drop-zone');
    const listTypes = document.getElementsByName('list_type');

    let opmlTitle = "Export";

    function isItemCompleted(node) {
        return node.getAttribute('_status') === '1' || 
               node.getAttribute('_complete') === 'true' || 
               node.getAttribute('_checked') === 'true';
    }

    function getNodeText(node) {
        const mt = node.getAttribute('_mubu_text');
        return mt ? decodeURIComponent(mt) : (node.getAttribute('text') || "");
    }

    function getNodeImg(node) {
        const mi = node.getAttribute('_mubu_images');
        if (!mi) return "";
        try {
            const imgs = JSON.parse(decodeURIComponent(mi));
            return imgs.map(i => `<br><img src="https://mubu.com/${i.uri}" />`).join("");
        } catch(e) { return ""; }
    }

    function convert() {
        const opmlStr = inputBox.value;
        if (!opmlStr) return;
        const xml = new DOMParser().parseFromString(opmlStr, "text/xml");
        const titleTag = xml.querySelector('title');
        if (titleTag) opmlTitle = titleTag.textContent;

        const results = [];
        let listStyle = Array.from(listTypes).find(r => r.checked).value;

        function walk(node, path) {
            if (node.tagName === 'outline' && isItemCompleted(node)) return;
            const children = Array.from(node.children).filter(c => c.tagName === 'outline' && !isItemCompleted(c));
            
            let currentCard = null;
            if (node.tagName === 'outline' && children.length > 0) {
                const isSummary = children.some(c => Array.from(c.children).some(gc => gc.tagName === 'outline'));
                const q = (isSummary ? "Σ " : "") + getNodeText(node) + getNodeImg(node);
                const ctx = "《" + path.join(" - ") + "》";
                const listTag = listStyle === 'ordered' ? 'ol' : (listStyle === 'unordered' ? 'ul' : 'div');
                const a = (listStyle === 'none' ? "" : `<${listTag}>`) + 
                          children.map(c => (listStyle === 'none' ? getNodeText(c)+getNodeImg(c)+"<br>" : `<li>${getNodeText(c)}${getNodeImg(c)}</li>`)).join("") + 
                          (listStyle === 'none' ? "" : `</${listTag}>`);
                currentCard = q.replace(/\t/g," ") + "\t" + ctx + "\t" + a.replace(/\t/g," ");
            }

            const currentText = node.tagName === 'outline' ? getNodeText(node).replace(/<[^>]+>/g, "").trim() : "";
            const nextPath = [...path];
            if (currentText) nextPath.push(currentText);

            children.forEach(c => walk(c, nextPath));
            if (currentCard) results.push(currentCard);
        }

        const body = xml.querySelector('body');
        if (body) walk(body, []);
        outputBox.value = results.join("\n");
        saveBtn.disabled = results.length === 0;
    }

    fileInput.addEventListener('change', e => {
        const file = e.target.files[0];
        if (!file) return;
        fileNameInfo.textContent = file.name;
        const reader = new FileReader();
        reader.onload = ev => { inputBox.value = ev.target.result; convert(); };
        reader.readAsText(file);
    });

    // 拖拽视觉反馈
    ['dragenter', 'dragover'].forEach(name => {
        dropZone.addEventListener(name, () => dropZone.classList.add('dragover'));
    });
    ['dragleave', 'drop'].forEach(name => {
        dropZone.addEventListener(name, () => dropZone.classList.remove('dragover'));
    });

    listTypes.forEach(r => r.addEventListener('change', convert));

    saveBtn.onclick = () => {
        const now = new Date();
        const dateStr = `${now.getFullYear()}年${String(now.getMonth()+1).padStart(2,'0')}月${String(now.getDate()).padStart(2,'0')}日`;
        const blob = new Blob(["\ufeff" + outputBox.value], { type: 'text/csv;charset=utf-8' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `${dateStr}-${opmlTitle}.csv`;
        a.click();
    };
})();
</script>
</body>
</html>
